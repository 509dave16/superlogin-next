'use strict';var fs=require('fs'),path=require('path'),BPromise=require('bluebird'),ejs=require('ejs'),extend=require('util')._extend,util=require('./util'),stateRequired=['google','linkedin'];module.exports=function(a,b,c,d){function e(a,b,e){var f=p(a.path);return c.createSession(a.user._id,f,a).then(function(a){return BPromise.resolve({error:null,session:a,link:null})}).then(function(a){var c=d.getItem('testMode.oauthTest')?fs.readFileSync(path.join(__dirname,'../templates/oauth/auth-callback-test.ejs'),'utf8'):fs.readFileSync(path.join(__dirname,'../templates/oauth/auth-callback.ejs'),'utf8');var e=ejs.render(c,a);b.status(200).send(e)},function(a){return e(a)})}function f(a,b,d){var e=q(a.path);return c.createSession(a.user._id,e,a).then(function(a){return BPromise.resolve(a)}).then(function(a){b.status(200).json(a)},function(a){return d(a)})}function g(a,b){var c,e=p(a.path);c=d.getItem('testMode.oauthTest')?fs.readFileSync(path.join(__dirname,'../templates/oauth/auth-callback-test.ejs'),'utf8'):fs.readFileSync(path.join(__dirname,'../templates/oauth/auth-callback.ejs'),'utf8');var f=ejs.render(c,{error:null,session:null,link:e});b.status(200).send(f)}function h(a,b){var c=q(a.path);b.status(200).json({ok:!0,success:util.capitalizeFirstLetter(c)+' successfully linked',provider:c})}function i(a,b,c){var e=d.getItem('testMode.oauthTest')?fs.readFileSync(path.join(__dirname,'../templates/oauth/auth-callback-test.ejs'),'utf8'):fs.readFileSync(path.join(__dirname,'../templates/oauth/auth-callback.ejs'),'utf8');var f=ejs.render(e,{error:a.message,session:null,link:null});console.error(a),a.stack&&console.error(a.stack),c.status(400).send(f)}function j(a,b,c){var d;d=b.user&&b.user._id?403:401,console.error(a),a.stack&&(console.error(a.stack),delete a.stack),c.status(d).json(a)}function k(c,f){c=c.toLowerCase();var h='providers.'+c;if(d.getItem(h+'.credentials')){var j=d.getItem(h+'.credentials');j.passReqToCallback=!0;var k=d.getItem(h+'.options')||{};f.call(null,j,b,l),a.get('/'+c,m(c,k,'login')),a.get('/'+c+'/callback',m(c,k,'login'),e,i),d.getItem('security.disableLinkAccounts')||(a.get('/link/'+c,b.authenticate('bearer',{session:!1}),m(c,k,'link')),a.get('/link/'+c+'/callback',b.authenticate('bearer',{session:!1}),m(c,k,'link'),g,i)),console.log(c+' loaded.')}}function l(a,b,d,e){return a.user&&a.user._id&&a.user.key?c.linkSocial(a.user._id,b,d,e,a):c.socialAuth(b,d,e,a)}function m(a,c,e){return function(f,g,h){var i=extend({},c);'linkedin'===a&&(i.state=!0);var j=f.query.bearer_token||f.query.state;j&&(-1<stateRequired.indexOf(a)||!0===d.getItem('providers.'+a+'.stateRequired'))&&(i.state=j),i.callbackURL=o(a,f,e,j),i.session=!1,b.authenticate(a,i)(f,g,h)}}function n(a,c){return function(d,e,f){var g=extend({},c);g.session=!1,b.authenticate(a+'-token',g)(d,e,f)}}function o(a,b,c,e){e&&(e=encodeURIComponent(e));var f=(b.get('X-Forwarded-Proto')||b.protocol)+'://';if('login'===c)return f+b.get('host')+b.baseUrl+'/'+a+'/callback';if('link'===c){var g;return g=e&&(-1<stateRequired.indexOf(a)||!0===d.getItem('providers.'+a+'.stateRequired'))?f+b.get('host')+b.baseUrl+'/link/'+a+'/callback':f+b.get('host')+b.baseUrl+'/link/'+a+'/callback?state='+e,g}}function p(a){var b=a.split('/'),c=b.indexOf('callback');if(0<c)return b[c-1]}function q(a){var b=a.split('/'),c=b.indexOf('token');if(0<c)return b[c-1]}return{registerProvider:k,registerOAuth2:function(a,b){k(a,function(c,d,e){d.use(new b(c,function(b,c,d,f,g){e(b,a,{accessToken:c,refreshToken:d},f).asCallback(g)}))})},registerTokenProvider:function(c,e){c=c.toLowerCase();var g='providers.'+c;if(d.getItem(g+'.credentials')){var i=d.getItem(g+'.credentials');i.passReqToCallback=!0;var k=d.getItem(g+'.options')||{};b.use(c+'-token',new e(i,function(a,b,d,e,f){l(a,c,{accessToken:b,refreshToken:d},e).asCallback(f)})),a.post('/'+c+'/token',n(c,k),f,j),d.getItem('security.disableLinkAccounts')||a.post('/link/'+c+'/token',b.authenticate('bearer',{session:!1}),n(c,k),h,j),console.log(c+'-token loaded.')}}}};