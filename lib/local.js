'use strict';var util=require('./util'),LocalStrategy=require('passport-local'),BearerStrategy=require('passport-http-bearer-sl').Strategy;module.exports=function(a,b,c){function d(b,d,e){var f={error:'Unauthorized',message:'Invalid username or password'};return c.handleFailedLogin(b,d).then(function(b){return b&&(f.message='Maximum failed login attempts exceeded. Your account has been locked for '+Math.round(a.getItem('security.lockoutTime')/60)+' minutes.'),e(null,!1,f)})}b.use(new BearerStrategy(function(a,b){var d=a.split(':');2>d.length&&b(null,!1,{message:'invalid token'});var e=d[0],f=d[1];c.confirmSession(e,f).then(function(a){b(null,a)},function(a){a instanceof Error?b(a,!1):b(null,!1,{message:a})})})),b.use(new LocalStrategy({usernameField:a.getItem('local.usernameField')||'username',passwordField:a.getItem('local.passwordField')||'password',session:!1,passReqToCallback:!0},function(b,e,f,g){c.get(e).then(function(c){if(c){if(c.local&&c.local.lockedUntil&&c.local.lockedUntil>Date.now())return g(null,!1,{error:'Unauthorized',message:'Your account is currently locked. Please wait a few minutes and try again.'});if(!c.local||!c.local.derived_key)return g(null,!1,{error:'Unauthorized',message:'Invalid username or password'});util.verifyPassword(c.local,f).then(function(){return a.getItem('local.requireEmailConfirm')&&!c.email?g(null,!1,{error:'Unauthorized',message:'You must confirm your email address.'}):g(null,c)},function(a){return a?g(a):d(c,b,g)})}else return g(null,!1,{error:'Unauthorized',message:'Invalid username or password'})},function(a){return g(a)})}))};