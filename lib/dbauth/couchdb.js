'use strict';var _typeof='function'==typeof Symbol&&'symbol'==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&'function'==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?'symbol':typeof a},BPromise=require('bluebird'),util=require('../util');module.exports=function(a){function b(a,b){return a.request({method:'PUT',url:'_security',body:b})}return this.storeKey=function(b,c,d,e,f){f=f instanceof Array?f.slice(0):[],f.unshift('user:'+b);var g={_id:'org.couchdb.user:'+c,type:'user',name:c,user_id:b,password:d,expires:e,roles:f};return a.upsert(g).then(function(){return g._id=c,BPromise.resolve(g)})},this.removeKeys=function(b){b=util.toArray(b);var c=[];b.forEach(function(a){c.push('org.couchdb.user:'+a)});var d=[];return a.allDocs({keys:c}).then(function(b){return b.rows.forEach(function(a){if(!a.error&&!a.value.deleted){var b={_id:a.id,_rev:a.value.rev,_deleted:!0};d.push(b)}}),d.length?a.bulkDocs(d):BPromise.resolve(!1)})},this.initSecurity=function(a,c,d){var e=!1;return a.get('_security').then(function(f){return f.admins||(f.admins={names:[],roles:[]}),f.admins.roles||(f.admins.roles=[]),f.members||(f.members={names:[],roles:[]}),f.members.roles||(f.admins.roles=[]),c.forEach(function(a){-1===f.admins.roles.indexOf(a)&&(e=!0,f.admins.roles.push(a))}),d.forEach(function(a){-1===f.members.roles.indexOf(a)&&(e=!0,f.members.roles.push(a))}),e?b(a,f):BPromise.resolve(!1)})},this.authorizeKeys=function(a,c,d){var e;if('object'===('undefined'==typeof d?'undefined':_typeof(d))&&!(d instanceof Array)){var f=[];Object.keys(d).forEach(function(a){f.push(a)}),d=f}return d=util.toArray(d),c.get('_security').then(function(a){e=a,e.members||(e.members={names:[],roles:[]}),e.members.names||(e.members.names=[]);var f=!1;return d.forEach(function(a){var b=e.members.names.indexOf(a);-1===b&&(e.members.names.push(a),f=!0)}),f?b(c,e):BPromise.resolve(!1)})},this.deauthorizeKeys=function(a,c){var d;return c=util.toArray(c),a.get('_security').then(function(e){if(d=e,!d.members||!d.members.names)return BPromise.resolve(!1);var f=!1;return c.forEach(function(a){var b=d.members.names.indexOf(a);-1<b&&(d.members.names.splice(b,1),f=!0)}),f?b(a,d):BPromise.resolve(!1)})},this};