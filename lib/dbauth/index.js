'use strict';var _typeof='function'==typeof Symbol&&'symbol'==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&'function'==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?'symbol':typeof a},BPromise=require('bluebird'),PouchDB=require('pouchdb-node'),util=require('./../util'),seed=require('pouchdb-seed-design'),request=require('superagent');module.exports=function(a,b,c){function d(a){return h.removeKeys(a)}function e(a,b,c,d,e){return h.authorizeKeys(a,b,c,d,e)}function f(a,b){return h.deauthorizeKeys(a,b)}function g(b,c){var d=[];return c||(c=util.getSessions(b)),c=util.toArray(c),b.personalDBs&&'object'===_typeof(b.personalDBs)?(Object.keys(b.personalDBs).forEach(function(b){var e=new PouchDB(util.getDBURL(a.getItem('dbServer'))+'/'+b);d.push(f(e,c))}),BPromise.all(d)):BPromise.resolve(!1)}var h,i=a.getItem('dbServer.cloudant');if(i)h=require('./cloudant');else{var j=require('./couchdb');h=new j(c)}return this.storeKey=function(a,b,c,d,e){return h.storeKey(a,b,c,d,e)},this.removeKeys=d,this.authorizeKeys=e,this.deauthorizeKeys=f,this.authorizeUserSessions=function(b,c,d,e){var f=this,g=[];return d=util.toArray(d),Object.keys(c).forEach(function(h){var i=c[h].permissions;i||(i=a.getItem('userDBs.model.'+c[h].name+'.permissions')||a.getItem('userDBs.model._default.permissions')||[]);var j=new PouchDB(util.getDBURL(a.getItem('dbServer'))+'/'+h);g.push(f.authorizeKeys(b,j,d,i,e))}),BPromise.all(g)},this.addUserDB=function(b,c,d,f,g,i,j){var k=this,l=[];i=i||[],j=j||[];var m,n,o=a.getItem('userDBs.privatePrefix')?a.getItem('userDBs.privatePrefix')+'_':'',p=b._id;return p=getLegalDBName(p),m='shared'===f?c:o+c+'$'+p,k.createDB(m).then(function(){return n=new PouchDB(util.getDBURL(a.getItem('dbServer'))+'/'+m),h.initSecurity(n,i,j)}).then(function(){d&&d instanceof Array&&d.forEach(function(a){var b=k.getDesignDoc(a);b?l.push(seed(n,b)):console.warn('Failed to locate design doc: '+a)});var a=[];if(b.session)for(var c in b.session)b.session.hasOwnProperty(c)&&b.session[c].expires>Date.now()&&a.push(c);return 0<a.length&&l.push(e(b._id,n,a,g,b.roles)),BPromise.all(l)}).then(function(){return BPromise.resolve(m)})},this.removeExpiredKeys=function(){var a={},c={},e=[];return b.query('auth/expiredKeys',{endkey:Date.now(),include_docs:!0}).then(function(b){return b.rows.forEach(function(b){a[b.value.user]=b.value.key,e.push(b.value.key),'undefined'==typeof c[b.value.user]&&(c[b.value.user]=b.doc),c[b.value.user].session&&Object.keys(c[b.value.user].session).forEach(function(a){b.value.key===a&&delete c[b.value.user].session[a]})}),d(e)}).then(function(){var b=[];return Object.keys(a).forEach(function(d){b.push(g(c[d],a[d]))}),BPromise.all(b)}).then(function(){var a=[];return Object.keys(c).forEach(function(b){a.push(c[b])}),b.bulkDocs(a)}).then(function(){return BPromise.resolve(e)})},this.deauthorizeUser=g,this.getDesignDoc=function(b){if(!b)return null;var c,d=a.getItem('userDBs.designDocDir');d||(d=__dirname);try{c=require(d+'/'+b)}catch(a){console.warn('Design doc: '+d+'/'+b+' not found.'),c=null}return c},this.getDBConfig=function(b,c){var d={name:b,adminRoles:a.getItem('userDBs.defaultSecurityRoles.admins')||[],memberRoles:a.getItem('userDBs.defaultSecurityRoles.members')||[]},e='userDBs.model.'+b;if(a.getItem(e)){d.permissions=a.getItem(e+'.permissions')||[],d.designDocs=a.getItem(e+'.designDocs')||[],d.type=c||a.getItem(e+'.type')||'private';var f=a.getItem(e+'.adminRoles'),g=a.getItem(e+'.memberRoles');f&&f instanceof Array&&f.forEach(function(a){a&&-1===d.adminRoles.indexOf(a)&&d.adminRoles.push(a)}),g&&g instanceof Array&&g.forEach(function(a){a&&-1===d.memberRoles.indexOf(a)&&d.memberRoles.push(a)})}else a.getItem('userDBs.model._default')?(d.permissions=a.getItem('userDBs.model._default.permissions')||[],d.designDocs=c&&'private'!==c?[]:a.getItem('userDBs.model._default.designDocs')||[],d.type=c||'private'):d.type=c||'private';return d},this.createDB=function(b){var c=util.getDBURL(a.getItem('dbServer'))+'/'+b;return BPromise.fromNode(function(a){request.put(c).send({}).end(a)}).then(function(a){return BPromise.resolve(JSON.parse(a.text))},function(a){return 412===a.status?BPromise.resolve(!1):BPromise.reject(a.text)})},this.removeDB=function(b){var c=new PouchDB(util.getDBURL(a.getItem('dbServer'))+'/'+b);return c.destroy()},this};function getLegalDBName(a){a=a.toLowerCase();var b=encodeURIComponent(a);return b=b.replace(/\./g,'%2E'),b=b.replace(/!/g,'%21'),b=b.replace(/~/g,'%7E'),b=b.replace(/\*/g,'%2A'),b=b.replace(/'/g,'%27'),b=b.replace(/\(/g,'%28'),b=b.replace(/\)/g,'%29'),b=b.replace(/\-/g,'%2D'),b=b.toLowerCase(),b=b.replace(/(%..)/g,function(a){return a=a.substr(1),'('+a+')'}),b}