'use strict';var url=require('url'),BPromise=require('bluebird'),request=require('superagent'),util=require('./../util');exports.storeKey=function(){return BPromise.resolve()},exports.removeKeys=function(){return BPromise.resolve()},exports.initSecurity=function(a,b,c){var d=!1;return a.get('_security').then(function(e){return e.admins||(e.admins={names:[],roles:[]}),e.admins.roles||(e.admins.roles=[]),e.members||(e.members={names:[],roles:[]}),e.members.roles||(e.admins.roles=[]),b.forEach(function(a){-1===e.admins.roles.indexOf(a)&&(d=!0,e.admins.roles.push(a))}),c.forEach(function(a){-1===e.members.roles.indexOf(a)&&(d=!0,e.members.roles.push(a))}),d?putSecurityCloudant(a,e):BPromise.resolve(!1)})},exports.authorizeKeys=function(a,b,c,d,e){var f={};return d||(d=['_reader','_replicator']),d=d.concat(e||[]),d.unshift('user:'+a),c=util.toArray(c),c instanceof Array?c.forEach(function(a){f[a]=d}):f=c,getSecurityCloudant(b).then(function(a){return a._id||(a._id='_security'),a.cloudant||(a.cloudant={}),Object.keys(f).forEach(function(b){a.cloudant[b]=f[b]}),putSecurityCloudant(b,a)})},exports.deauthorizeKeys=function(a,b){return b=util.toArray(b),getSecurityCloudant(a).then(function(c){var d=!1;return c.cloudant?(b.forEach(function(a){c.cloudant[a]&&(d=!0,delete c.cloudant[a])}),d?putSecurityCloudant(a,c):BPromise.resolve(!1)):BPromise.resolve(!1)})},exports.getAPIKey=function(a){var b=url.parse(a.name);b.pathname='/_api/v2/api_keys';var c=url.format(b);return BPromise.fromNode(function(a){request.post(c).end(a)}).then(function(a){var b=JSON.parse(a.text);return b.key&&b.password&&!0===b.ok?BPromise.resolve(b):BPromise.reject(b)})};var getSecurityCloudant=exports.getSecurityCloudant=function(a){var b=getSecurityUrl(a);return BPromise.fromNode(function(a){request.get(b).end(a)}).then(function(a){return BPromise.resolve(JSON.parse(a.text))})},putSecurityCloudant=exports.putSecurityCloudant=function(a,b){var c=getSecurityUrl(a);return BPromise.fromNode(function(a){request.put(c).send(b).end(a)}).then(function(a){return BPromise.resolve(JSON.parse(a.text))})};function getSecurityUrl(a){var b=url.parse(a.name);return b.pathname+='/_security',url.format(b)}