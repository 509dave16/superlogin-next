'use strict';var _typeof='function'==typeof Symbol&&'symbol'==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&'function'==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?'symbol':typeof a},events=require('events'),express=require('express'),BPromise=require('bluebird'),PouchDB=require('pouchdb-node'),seed=require('pouchdb-seed-design'),Configure=require('./configure'),User=require('./user'),Oauth=require('./oauth'),loadRoutes=require('./routes'),localConfig=require('./local'),Middleware=require('./middleware'),Mailer=require('./mailer'),util=require('./util');PouchDB.plugin(require('pouchdb-upsert')),module.exports=function(a,b,c,d){var e=new Configure(a,require('../config/default.config')),f=express.Router(),g=new events.EventEmitter;b&&'object'===('undefined'==typeof b?'undefined':_typeof(b))||(b=require('passport'));var h=new Middleware(b);if(a||(e.setItem('testMode.noEmail',!0),e.setItem('testMode.debugEmail',!0)),!c&&e.getItem('dbServer.userDB')&&(c=new PouchDB(util.getFullDBURL(e.getItem('dbServer'),e.getItem('dbServer.userDB')))),d||!e.getItem('dbServer.couchAuthDB')||e.getItem('dbServer.cloudant')||(d=new PouchDB(util.getFullDBURL(e.getItem('dbServer'),e.getItem('dbServer.couchAuthDB')))),!c||'object'!==('undefined'==typeof c?'undefined':_typeof(c)))throw new Error('userDB must be passed in as the third argument or specified in the config file under dbServer.userDB');var i=new Mailer(e),j=new User(e,c,d,i,g),k=new Oauth(f,b,j,e),l=require('../designDocs/user-design');l=util.addProvidersToDesignDoc(e,l),seed(c,l),localConfig(e,b,j),loadRoutes(e,f,b,j);var m={config:e,router:f,mailer:i,passport:b,userDB:c,couchAuthDB:d,registerProvider:k.registerProvider,registerOAuth2:k.registerOAuth2,registerTokenProvider:k.registerTokenProvider,validateUsername:j.validateUsername,validateEmail:j.validateEmail,validateEmailUsername:j.validateEmailUsername,getUser:j.get,createUser:j.create,onCreate:j.onCreate,onLink:j.onLink,socialAuth:j.socialAuth,hashPassword:util.hashPassword,verifyPassword:util.verifyPassword,createSession:j.createSession,changePassword:j.changePassword,changeEmail:j.changeEmail,resetPassword:j.resetPassword,forgotPassword:j.forgotPassword,verifyEmail:j.verifyEmail,addUserDB:j.addUserDB,removeUserDB:j.removeUserDB,logoutUser:j.logoutUser,logoutSession:j.logoutSession,logoutOthers:j.logoutOthers,removeUser:j.remove,confirmSession:j.confirmSession,removeExpiredKeys:j.removeExpiredKeys,sendEmail:i.sendEmail,quitRedis:j.quitRedis,requireAuth:h.requireAuth,requireRole:h.requireRole,requireAnyRole:h.requireAnyRole,requireAllRoles:h.requireAllRoles};for(var n in g)m[n]=g[n];return m};