'use strict';var BPromise=require('bluebird'),URLSafeBase64=require('urlsafe-base64'),uuid=require('uuid'),pwd=require('couch-pwd'),crypto=require('crypto');exports.URLSafeUUID=function(){return URLSafeBase64.encode(uuid.v4(null,new Buffer(16)))},exports.hashToken=function(a){return crypto.createHash('sha256').update(a).digest('hex')},exports.hashPassword=function(a){return new BPromise(function(b,c){pwd.hash(a,function(a,d,e){return a?c(a):b({salt:d,derived_key:e})})})},exports.verifyPassword=function(a,b){var c=BPromise.promisify(pwd.hash,{context:pwd}),d=a.iterations,e=a.salt,f=a.derived_key;return d&&pwd.iterations(d),e&&f?c(b,e).then(function(a){return a===f?BPromise.resolve(!0):BPromise.reject(!1)}):BPromise.reject(!1)},exports.getDBURL=function(a){var b;return b=a.user?a.protocol+encodeURIComponent(a.user)+':'+encodeURIComponent(a.password)+'@'+a.host:a.protocol+a.host,b},exports.getFullDBURL=function(a,b){return exports.getDBURL(a)+'/'+b},exports.toArray=function(a){return a instanceof Array||(a=[a]),a},exports.getSessions=function(a){var b=[];return a.session&&Object.keys(a.session).forEach(function(a){b.push(a)}),b},exports.getExpiredSessions=function(a,b){var c=[];return a.session&&Object.keys(a.session).forEach(function(d){a.session[d].expires<=b&&c.push(d)}),c},exports.getSessionToken=function(a){if(a.headers&&a.headers.authorization){var b=a.headers.authorization.split(' ');if(2==b.length){var c=b[0],d=b[1];if(/^Bearer$/i.test(c)){var e=d.split(':');return 2>e.length?void 0:e[0]}}}},exports.addProvidersToDesignDoc=function(a,b){var c=a.getItem('providers');if(!c)return b;return Object.keys(c).forEach(function(a){b.auth.views[a]='function(doc) {\n  if(doc.%PROVIDER% && doc.%PROVIDER%.profile) {\n    emit(doc.%PROVIDER%.profile.id, null);\n  }\n}'.replace(/%PROVIDER%/g,a)}),b},exports.capitalizeFirstLetter=function(a){return a.charAt(0).toUpperCase()+a.slice(1)},exports.getObjectRef=function(a,b){b=b.replace(/\[(\w+)\]/g,'.$1'),b=b.replace(/^\./,'');for(var c=b.split('.');c.length;){var d=c.shift();if(d in a)a=a[d];else return}return a},exports.setObjectRef=function(a,b,c){b=b.replace(/\[(\w+)\]/g,'.$1'),b=b.replace(/^\./,'');for(var d,e=b.split('.'),f=e.length,g=0;g<f-1;g++)d=e[g],a[d]||(a[d]={}),a=a[d];return a[e[f-1]]=c,c},exports.delObjectRef=function(a,b){b=b.replace(/\[(\w+)\]/g,'.$1'),b=b.replace(/^\./,'');for(var c,d=b.split('.'),e=d.length,f=0;f<e-1;f++){if(c=d[f],!a[c])return!1;a=a[c]}return delete a[d[e-1]],!0},exports.arrayUnion=function(c,a){for(var b=c.concat(a),d=0;d<b.length;++d)for(var e=d+1;e<b.length;++e)b[d]===b[e]&&b.splice(e--,1);return b};