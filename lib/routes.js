'use strict';var util=require('./util');module.exports=function(a,b,c,d){var e=process.env.NODE_ENV||'development';b.post('/login',function(a,b,d){c.authenticate('local',function(c,e,f){return c?d(c):e?(a.logIn(e,{session:!1},function(a){if(a)return d(a)}),d()):b.status(401).json(f)})(a,b,d)},function(a,b,c){return d.createSession(a.user._id,'local',a).then(function(a){b.status(200).json(a)},function(a){return c(a)})}),b.post('/refresh',c.authenticate('bearer',{session:!1}),function(a,b,c){return d.refreshSession(a.user.key).then(function(a){b.status(200).json(a)},function(a){return c(a)})}),b.post('/logout',function(a,b,c){var e=util.getSessionToken(a);return e?void d.logoutSession(e).then(function(){b.status(200).json({ok:!0,success:'Logged out'})},function(a){return console.error('Logout failed'),c(a)}):c({error:'unauthorized',status:401})}),b.post('/logout-others',c.authenticate('bearer',{session:!1}),function(a,b,c){d.logoutOthers(a.user.key).then(function(){b.status(200).json({success:'Other sessions logged out'})},function(a){return console.error('Logout failed'),c(a)})}),b.post('/logout-all',function(a,b,c){var e=util.getSessionToken(a);return e?void d.logoutUser(null,e).then(function(){b.status(200).json({success:'Logged out'})},function(a){return console.error('Logout-all failed'),c(a)}):c({error:'unauthorized',status:401})}),b.post('/register',function(b,c,e){d.create(b.body,b).then(function(f){return a.getItem('security.loginOnRegistration')?d.createSession(f._id,'local',b.ip).then(function(a){c.status(200).json(a)},function(a){return e(a)}):void c.status(201).json({success:'User created.'})},function(a){return e(a)})}),b.post('/forgot-password',function(a,b,c){d.forgotPassword(a.body.email,a).then(function(){b.status(200).json({success:'Password recovery email sent.'})},function(a){return c(a)})}),b.post('/password-reset',function(b,c,e){d.resetPassword(b.body,b).then(function(f){return a.getItem('security.loginOnPasswordReset')?d.createSession(f._id,'local',b.ip).then(function(a){c.status(200).json(a)},function(a){return e(a)}):void c.status(200).json({success:'Password successfully reset.'})},function(a){return e(a)})}),b.post('/password-change',c.authenticate('bearer',{session:!1}),function(a,b,c){d.changePasswordSecure(a.user._id,a.body,a).then(function(){b.status(200).json({success:'password changed'})},function(a){return c(a)})}),b.post('/unlink/:provider',c.authenticate('bearer',{session:!1}),function(a,b,c){var e=a.params.provider;d.unlink(a.user._id,e).then(function(){b.status(200).json({success:util.capitalizeFirstLetter(e)+' unlinked'})},function(a){return c(a)})}),b.get('/confirm-email/:token',function(b,c,e){var f=a.getItem('local.confirmEmailRedirectURL');if(!b.params.token){var g={error:'Email verification token required'};return f?c.status(201).redirect(f+'?error='+encodeURIComponent(g.error)):c.status(400).send(g)}d.verifyEmail(b.params.token,b).then(function(){return f?c.status(201).redirect(f+'?success=true'):void c.status(200).send({ok:!0,success:'Email verified'})},function(a){if(f){var b='?error='+encodeURIComponent(a.error);return a.message&&(b+='&message='+encodeURIComponent(a.message)),c.status(201).redirect(f+b)}return e(a)})}),b.get('/validate-username/:username',function(a,b,c){return a.params.username?void d.validateUsername(a.params.username).then(function(a){a?b.status(409).json({error:'Username already in use'}):b.status(200).json({ok:!0})},function(a){return c(a)}):c({error:'Username required',status:400})}),b.get('/validate-email/:email',function(b,c,e){var f;return b.params.email?void(f=a.getItem('local.emailUsername')?d.validateEmailUsername(b.params.email):d.validateEmail(b.params.email),f.then(function(a){a?c.status(409).json({error:'Email already in use'}):c.status(200).json({ok:!0})},function(a){return e(a)})):e({error:'Email required',status:400})}),b.post('/change-email',c.authenticate('bearer',{session:!1}),function(a,b,c){d.changeEmail(a.user._id,a.body.newEmail,a).then(function(){b.status(200).json({ok:!0,success:'Email changed'})},function(a){return c(a)})}),b.get('/session',c.authenticate('bearer',{session:!1}),function(a,b){var c=a.user;c.user_id=c._id,delete c._id,delete c.key,b.status(200).json(c)}),b.use(function(a,b,c){console.error(a),a.stack&&console.error(a.stack),c.status(a.status||500),a.stack&&'development'!==e&&delete a.stack,c.json(a)})};