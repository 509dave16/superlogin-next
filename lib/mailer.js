'use strict';var fs=require('fs'),BPromise=require('bluebird'),nodemailer=require('nodemailer'),ejs=require('ejs');module.exports=function(a){var b,c=a.getItem('mailer.transport');return b=a.getItem('testMode.noEmail')?nodemailer.createTransport(require('nodemailer-stub-transport')()):c?nodemailer.createTransport(c(a.getItem('mailer.options'))):nodemailer.createTransport(a.getItem('mailer.options')),this.sendEmail=function(c,d,e){var f=a.getItem('emails.'+c+'.template');if(!f)return BPromise.reject('No template found for "'+c+'".');var g=fs.readFileSync(f,'utf8');if(!g)return BPromise.reject('Failed to locate template file: '+f);var h=ejs.render(g,e),i=a.getItem('emails.'+c+'.subject'),j=a.getItem('emails.'+c+'.format'),k={from:a.getItem('mailer.fromEmail'),to:d,subject:i};'html'===j?k.html=h:k.text=h,a.getItem('testMode.debugEmail')&&console.log(k);var l=BPromise.promisify(b.sendMail,{context:b});return l(k)},this};