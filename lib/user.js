'use strict';var _typeof='function'==typeof Symbol&&'symbol'==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&'function'==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?'symbol':typeof a},url=require('url'),BPromise=require('bluebird'),Model=require('sofa-model'),nodemailer=require('nodemailer'),extend=require('extend'),Session=require('./session'),util=require('./util'),DBAuth=require('./dbauth'),EMAIL_REGEXP=/^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,6}$/,USER_REGEXP=/^[a-z0-9_-]{3,16}$/;module.exports=function(a,b,c,d,e){function f(a,b,c){var d;return a.forEach(function(a){if(!d)d=a.call(null,b,c);else{if(!d.then||'function'!=typeof d.then)throw new Error('onCreate function must return a promise');d.then(function(b){return a.call(null,b,c)})}}),d||(d=BPromise.resolve(b)),d}function g(c,d){var e;if(a.getItem('dbServer.cloudant'))e=require('./dbauth/cloudant').getAPIKey(b);else{for(var f=util.URLSafeUUID();'_'===f[0]||'-'===f[0];)f=util.URLSafeUUID();e=BPromise.resolve({key:f,password:util.URLSafeUUID()})}return e.then(function(a){var b=Date.now();return BPromise.resolve({_id:c,key:a.key,password:a.password,issued:b,expires:b+1e3*p,roles:d})})}function h(a){a=a.toLowerCase();var c,d=[];return b.allDocs({startkey:a,endkey:a+'\uFFFF',include_docs:!1}).then(function(b){if(0===b.rows.length)return BPromise.resolve(a);for(var e=0;e<b.rows.length;e++)d.push(b.rows[e].id);if(-1===d.indexOf(a))return BPromise.resolve(a);for(var f=0;!c;)f++,-1===d.indexOf(a+f)&&(c=a+f);return BPromise.resolve(c)})}function i(b){if(!a.getItem('userDBs.defaultDBs'))return BPromise.resolve(b);var c=[];b.personalDBs={};var d=function(a,d){a.forEach(function(a){var e=k.getDBConfig(a);c.push(k.addUserDB(b,a,e.designDocs,d,e.permissions,e.adminRoles,e.memberRoles).then(function(a){delete e.permissions,delete e.adminRoles,delete e.memberRoles,delete e.designDocs,e.type=d,b.personalDBs[a]=e}))})},e=a.getItem('userDBs.defaultDBs.private');Array.isArray(e)||(e=[]),d(e,'private');var f=a.getItem('userDBs.defaultDBs.shared');return Array.isArray(f)||(f=[]),d(f,'shared'),BPromise.all(c).then(function(){return BPromise.resolve(b)})}var j=this,k=new DBAuth(a,b,c),l=new Session(a),m=[],n=[],o=a.getItem('security.tokenLife')||86400,p=a.getItem('security.sessionLife')||86400,q=a.getItem('local.emailUsername');this.validateUsername=function(a){return a?a.match(USER_REGEXP)?b.query('auth/username',{key:a}).then(function(a){return 0===a.rows.length?BPromise.resolve():BPromise.resolve('already in use')},function(a){throw new Error(a)}):BPromise.resolve('Invalid username'):BPromise.resolve()},this.validateEmail=function(a){return a?a.match(EMAIL_REGEXP)?b.query('auth/email',{key:a}).then(function(a){return 0===a.rows.length?BPromise.resolve():BPromise.resolve('already in use')},function(a){throw new Error(a)}):BPromise.resolve('invalid email'):BPromise.resolve()},this.validateEmailUsername=function(a){return a?a.match(EMAIL_REGEXP)?b.query('auth/emailUsername',{key:a}).then(function(a){return 0===a.rows.length?BPromise.resolve():BPromise.resolve('already in use')},function(a){throw new Error(a)}):BPromise.resolve('invalid email'):BPromise.resolve()},this.matches=function(a,b,c,d){if(d&&d[b]!==a)return'does not match '+b};var r={presence:!0,length:{minimum:6,message:'must be at least 6 characters'},matches:'confirmPassword'};r=extend(!0,{},r,a.getItem('local.passwordConstraints'));var s={async:!0,whitelist:['name','username','email','password','confirmPassword'],customValidators:{validateEmail:j.validateEmail,validateUsername:j.validateUsername,validateEmailUsername:j.validateEmailUsername,matches:j.matches},sanitize:{name:['trim'],username:['trim','toLowerCase'],email:['trim','toLowerCase']},validate:{email:{presence:!0,validateEmail:!0},username:{presence:!0,validateUsername:!0},password:r,confirmPassword:{presence:!0}},static:{type:'user',roles:a.getItem('security.defaultRoles'),providers:['local']},rename:{username:'_id'}};q&&(delete s.validate.username,delete s.validate.email.validateEmail,delete s.rename.username,s.validate.email.validateEmailUsername=!0);var t={async:!0,customValidators:{matches:j.matches},validate:{token:{presence:!0},password:r,confirmPassword:{presence:!0}}},u={async:!0,customValidators:{matches:j.matches},validate:{newPassword:r,confirmPassword:{presence:!0}}};return this.onCreate=function(a){if('function'==typeof a)m.push(a);else throw new TypeError('onCreate: You must pass in a function')},this.onLink=function(a){if('function'==typeof a)n.push(a);else throw new TypeError('onLink: You must pass in a function')},this.get=function(a){var c;return c=q?'emailUsername':EMAIL_REGEXP.test(a)?'email':'username',b.query('auth/'+c,{key:a,include_docs:!0}).then(function(a){return 0<a.rows.length?BPromise.resolve(a.rows[0].doc):BPromise.resolve(null)})},this.create=function(c,g){g=g||{};var h=s,k=a.getItem('userModel');if('object'===('undefined'==typeof k?'undefined':_typeof(k))){var l;k.whitelist&&(l=util.arrayUnion(s.whitelist,k.whitelist)),h=extend(!0,{},s,a.getItem('userModel')),h.whitelist=l||h.whitelist}var n,o=new Model(h),p=new o(c);return p.process().then(function(b){return n=b,q&&(n._id=n.email),a.getItem('local.sendConfirmEmail')&&(n.unverifiedEmail={email:n.email,token:util.URLSafeUUID()},delete n.email),util.hashPassword(n.password)},function(a){return BPromise.reject({error:'Validation failed',validationErrors:a,status:400})}).then(function(a){return n.local={},n.local.salt=a.salt,n.local.derived_key=a.derived_key,delete n.password,delete n.confirmPassword,n.signUp={provider:'local',timestamp:new Date().toISOString(),ip:g.ip},i(n)}).then(function(a){return j.logActivity(a._id,'signup','local',g,a)}).then(function(a){return f(m,a,'local')}).then(function(a){return b.upsert(a)}).then(function(b){return n._rev=b.rev,a.getItem('local.sendConfirmEmail')?d.sendEmail('confirmEmail',n.unverifiedEmail.email,{req:g,user:n}):BPromise.resolve()}).then(function(){return e.emit('signup',n,'local'),BPromise.resolve(n)})},this.socialAuth=function(c,d,g,k){var l,o,p,r=!1;k=k||{};var s=k.ip;return BPromise.resolve().then(function(){return b.query('auth/'+c,{key:g.id,include_docs:!0})}).then(function(b){if(0<b.rows.length)return l=b.rows[0].doc,BPromise.resolve();r=!0,l={},l[c]={},g.emails&&(l.email=g.emails[0].value),l.providers=[c],l.type='user',l.roles=a.getItem('security.defaultRoles'),l.signUp={provider:c,timestamp:new Date().toISOString(),ip:s};var d=function(){return BPromise.reject({error:'Email already in use',message:'Your email is already in use. Try signing in first and then linking this account.',status:409})};if(q)return l.email?j.validateEmailUsername(l.email).then(function(a){return a?d():BPromise.resolve(l.email.toLowerCase())}):BPromise.reject({error:'No email provided',message:'An email is required for registration, but '+c+' didn\'t supply one.',status:400});if(g.username)p=g.username.toLowerCase();else if(l.email){var e=l.email.split('@');p=e[0].toLowerCase()}else p=g.displayName?g.displayName.replace(/\s/g,'').toLowerCase():g.id.toLowerCase();return j.validateEmail(l.email).then(function(a){return a?d():h(p)})}).then(function(a){return a&&(l._id=a),l[c].auth=d,l[c].profile=g,l.name||(l.name=g.displayName),delete l[c].profile._raw,r?i(l):BPromise.resolve(l)}).then(function(a){return o=r?'signup':'login',j.logActivity(a._id,o,c,k,a)}).then(function(a){return r?f(m,a,c):f(n,a,c)}).then(function(a){return b.upsert(a)}).then(function(){return'signup'===o&&e.emit('signup',l,c),BPromise.resolve(l)})},this.linkSocial=function(a,c,d,e,g){g=g||{};var h;return BPromise.resolve().then(function(){return b.query('auth/'+c,{key:e.id})}).then(function(b){return 0===b.rows.length?BPromise.resolve():b.rows[0].id===a?void 0:BPromise.reject({error:'Conflict',message:'This '+c+' profile is already in use by another account.',status:409})}).then(function(){return b.get(a)}).then(function(a){return h=a,h[c]&&h[c].profile.id!==e.id?BPromise.reject({error:'Conflict',message:'Your account is already linked with another '+c+'profile.',status:409}):e.emails?q?b.query('auth/emailUsername',{key:e.emails[0].value}):b.query('auth/email',{key:e.emails[0].value}):BPromise.resolve({rows:[]})}).then(function(b){var c;return 0===b.rows.length?c=!0:(c=!0,b.rows.forEach(function(b){b.id!==a&&(c=!1)})),c?BPromise.resolve():BPromise.reject({error:'Conflict',message:'The email '+e.emails[0].value+' is already in use by another account.',status:409})}).then(function(){return h[c]={},h[c].auth=d,h[c].profile=e,h.providers||(h.providers=[]),-1===h.providers.indexOf(c)&&h.providers.push(c),h.name||(h.name=e.displayName),delete h[c].profile._raw,j.logActivity(h._id,'link',c,g,h)}).then(function(a){return f(n,a,c)}).then(function(a){return b.upsert(a)}).then(function(){return BPromise.resolve(h)})},this.unlink=function(a,c){var d;return b.get(a).then(function(a){return(d=a,!c)?BPromise.reject({error:'Unlink failed',message:'You must specify a provider to unlink.',status:400}):d.providers&&d.providers instanceof Array&&!(2>d.providers.length)?'local'===c?BPromise.reject({error:'Unlink failed',message:'You can\'t unlink local.',status:400}):d[c]&&'object'===_typeof(d[c])?(delete d[c],d.providers.splice(d.providers.indexOf(c),1),b.upsert(d)):BPromise.reject({error:'Unlink failed',message:'Provider: '+util.capitalizeFirstLetter(c)+' not found.',status:404}):BPromise.reject({error:'Unlink failed',message:'You can\'t unlink your only provider!',status:400})}).then(function(){return BPromise.resolve(d)})},this.createSession=function(c,d,f){var h,i,m,n;f=f||{};var o=f.ip;return b.get(c).then(function(a){return h=a,g(h._id,h.roles)}).then(function(a){return n=a.password,i=a,i.provider=d,l.storeToken(i)}).then(function(){return k.storeKey(c,i.key,n,i.expires,h.roles)}).then(function(){return h.personalDBs?k.authorizeUserSessions(c,h.personalDBs,i.key,h.roles):BPromise.resolve()}).then(function(){return h.session||(h.session={}),m={issued:i.issued,expires:i.expires,provider:d,ip:o},h.session[i.key]=m,'local'===d&&(!h.local&&(h.local={}),h.local.failedLoginAttempts=0,delete h.local.lockedUntil),j.logActivity(h._id,'login',d,f,h)}).then(function(a){return j.logoutUserSessions(a,'expired')}).then(function(a){return h=a,b.upsert(a)}).then(function(){if(m.token=i.key,m.password=n,m.user_id=h._id,m.roles=h.roles,'object'===_typeof(h.personalDBs)){var b,c={};if(a.getItem('dbServer.publicURL')){var f=url.parse(a.getItem('dbServer.publicURL'));f.auth=m.token+':'+m.password,b=f.format()}else b=a.getItem('dbServer.protocol')+m.token+':'+m.password+'@'+a.getItem('dbServer.host')+'/';Object.keys(h.personalDBs).forEach(function(a){c[h.personalDBs[a].name]=b+a}),m.userDBs=c}return h.profile&&(m.profile=h.profile),e.emit('login',m,d),BPromise.resolve(m,d)})},this.handleFailedLogin=function(c,d){d=d||{};var e=a.getItem('security.maxFailedLogins');return e?(c.local||(c.local={}),c.local.failedLoginAttempts||(c.local.failedLoginAttempts=0),c.local.failedLoginAttempts++,c.local.failedLoginAttempts>e&&(c.local.failedLoginAttempts=0,c.local.lockedUntil=Date.now()+1e3*a.getItem('security.lockoutTime')),j.logActivity(c._id,'failed login','local',d,c).then(function(a){return b.upsert(a)}).then(function(){return BPromise.resolve(!!c.local.lockedUntil)})):BPromise.resolve()},this.logActivity=function(c,d,e,f,g,h){var i=a.getItem('security.userActivityLogSize');if(!i)return BPromise.resolve(g);var j;return g?j=BPromise.resolve(g):(!1!==h&&(h=!0),j=b.get(c)),j.then(function(a){g=a,g.activity&&g.activity instanceof Array||(g.activity=[]);var c={timestamp:new Date().toISOString(),action:d,provider:e,ip:f.ip};for(g.activity.unshift(c);g.activity.length>i;)g.activity.pop();return h?b.upsert(g).then(function(){return BPromise.resolve(g)}):BPromise.resolve(g)})},this.refreshSession=function(a){var c;return l.fetchToken(a).then(function(a){return c=a,c.expires=Date.now()+1e3*p,BPromise.all([b.get(c._id),l.storeToken(c)])}).then(function(b){var d=b[0];return d.session[a].expires=c.expires,j.logoutUserSessions(d,'expired')}).then(function(a){return b.upsert(a)}).then(function(){return delete c.password,c.token=c.key,delete c.key,c.user_id=c._id,delete c._id,delete c.salt,delete c.derived_key,e.emit('refresh',c),BPromise.resolve(c)})},this.resetPassword=function(a,c){c=c||{};var d,f=new Model(t),g=new f(a);return g.validate().then(function(){var c=util.hashToken(a.token);return b.query('auth/passwordReset',{key:c,include_docs:!0})},function(a){return BPromise.reject({error:'Validation failed',validationErrors:a,status:400})}).then(function(b){return b.rows.length?(d=b.rows[0].doc,d.forgotPassword.expires<Date.now()?BPromise.reject({status:400,error:'Token expired'}):util.hashPassword(a.password)):BPromise.reject({status:400,error:'Invalid token'})}).then(function(a){return d.local||(d.local={}),d.local.salt=a.salt,d.local.derived_key=a.derived_key,-1===d.providers.indexOf('local')&&d.providers.push('local'),j.logoutUserSessions(d,'all')}).then(function(a){return d=a,delete d.forgotPassword,j.logActivity(d._id,'reset password','local',c,d)}).then(function(a){return b.upsert(a)}).then(function(){return e.emit('password-reset',d),BPromise.resolve(d)})},this.changePasswordSecure=function(a,c,d){d=d||{};var e,f=this,g=new Model(u),h=new g(c);return h.validate().then(function(){return b.get(a)},function(a){return BPromise.reject({error:'Validation failed',validationErrors:a,status:400})}).then(function(){return b.get(a)}).then(function(a){return e=a,e.local&&e.local.salt&&e.local.derived_key?c.currentPassword?util.verifyPassword(e.local,c.currentPassword):BPromise.reject({error:'Password change failed',message:'You must supply your current password in order to change it.',status:400}):BPromise.resolve()}).then(function(){return f.changePassword(e._id,c.newPassword,e,d)},function(a){return BPromise.reject(a||{error:'Password change failed',message:'The current password you supplied is incorrect.',status:400})}).then(function(){return d.user&&d.user.key?f.logoutOthers(d.user.key):BPromise.resolve()})},this.changePassword=function(a,c,d,f){f=f||{};var g,h;return g=d?BPromise.resolve(d):b.get(a),g.then(function(a){return h=a,util.hashPassword(c)},function(){return BPromise.reject({error:'User not found',status:404})}).then(function(a){return h.local||(h.local={}),h.local.salt=a.salt,h.local.derived_key=a.derived_key,-1===h.providers.indexOf('local')&&h.providers.push('local'),j.logActivity(h._id,'changed password','local',f,h)}).then(function(a){return b.upsert(a)}).then(function(){e.emit('password-change',h)})},this.forgotPassword=function(a,c){c=c||{};var f,g,h;return b.query('auth/email',{key:a,include_docs:!0}).then(function(a){return a.rows.length?(f=a.rows[0].doc,g=util.URLSafeUUID(),h=util.hashToken(g),f.forgotPassword={token:h,issued:Date.now(),expires:Date.now()+1e3*o},j.logActivity(f._id,'forgot password','local',c,f)):BPromise.reject({error:'User not found',status:404})}).then(function(a){return b.upsert(a)}).then(function(){return d.sendEmail('forgotPassword',f.email||f.unverifiedEmail.email,{user:f,req:c,token:g})}).then(function(){return e.emit('forgot-password',f),BPromise.resolve(f.forgotPassword)})},this.verifyEmail=function(a,c){c=c||{};var d;return b.query('auth/verifyEmail',{key:a,include_docs:!0}).then(function(a){return a.rows.length?(d=a.rows[0].doc,d.email=d.unverifiedEmail.email,delete d.unverifiedEmail,e.emit('email-verified',d),j.logActivity(d._id,'verified email','local',c,d)):BPromise.reject({error:'Invalid token',status:400})}).then(function(a){return b.upsert(a)})},this.changeEmail=function(c,f,g){g=g||{},g.user||(g.user={provider:'local'});var h;return j.validateEmail(f).then(function(a){return a?BPromise.reject(a):b.get(c)}).then(function(b){return h=b,a.getItem('local.sendConfirmEmail')?(h.unverifiedEmail={email:f,token:util.URLSafeUUID()},d.sendEmail('confirmEmail',h.unverifiedEmail.email,{req:g,user:h})):(h.email=f,BPromise.resolve())}).then(function(){return e.emit('email-changed',h),j.logActivity(h._id,'changed email',g.user.provider,g,h)}).then(function(a){return b.upsert(a)})},this.addUserDB=function(a,c,d,f,g){var h,i=k.getDBConfig(c,d||'private');return i.designDocs=f||i.designDocs||'',i.permissions=g||i.permissions,b.get(a).then(function(a){return h=a,k.addUserDB(h,c,i.designDocs,i.type,i.permissions,i.adminRoles,i.memberRoles)}).then(function(d){return h.personalDBs||(h.personalDBs={}),delete i.designDocs,g||delete i.permissions,delete i.adminRoles,delete i.memberRoles,h.personalDBs[d]=i,e.emit('user-db-added',a,c),b.upsert(h)})},this.removeUserDB=function(a,c,d,f){var g,h=!1;return b.get(a).then(function(a){return g=a,g.personalDBs&&'object'===_typeof(g.personalDBs)&&Object.keys(g.personalDBs).forEach(function(a){if(g.personalDBs[a].name===c){var b=g.personalDBs[a].type;if(delete g.personalDBs[a],h=!0,'private'===b&&d)return k.removeDB(c);if('shared'===b&&f)return k.removeDB(c)}}),BPromise.resolve()}).then(function(){return h?(e.emit('user-db-removed',a,c),b.upsert(g)):BPromise.resolve()})},this.logoutUser=function(a,c){var d,f;if(a)d=b.get(a);else{if(!c)return BPromise.reject({error:'unauthorized',message:'Either user_id or session_id must be specified',status:401});d=b.query('auth/session',{key:c,include_docs:!0}).then(function(a){return a.rows.length?BPromise.resolve(a.rows[0].doc):BPromise.reject({error:'unauthorized',status:401})})}return d.then(function(b){return f=b,a=b._id,j.logoutUserSessions(f,'all')}).then(function(){return e.emit('logout',a),e.emit('logout-all',a),b.upsert(f)})},this.logoutSession=function(a){var c,d=0,f=0;return b.query('auth/session',{key:a,include_docs:!0}).then(function(b){if(!b.rows.length)return BPromise.reject({error:'unauthorized',status:401});c=b.rows[0].doc,c.session&&(d=Object.keys(c.session).length,c.session[a]&&delete c.session[a]);var e=[];return e.push(l.deleteTokens(a)),e.push(k.removeKeys(a)),c&&e.push(k.deauthorizeUser(c,a)),BPromise.all(e)}).then(function(){return j.logoutUserSessions(c,'expired')}).then(function(a){return c=a,c.session&&(f=Object.keys(c.session).length),e.emit('logout',c._id),d===f?BPromise.resolve(!1):b.upsert(c)})},this.logoutOthers=function(a){var c;return b.query('auth/session',{key:a,include_docs:!0}).then(function(b){return b.rows.length&&(c=b.rows[0].doc,c.session&&c.session[a])?j.logoutUserSessions(c,'other',a):BPromise.resolve()}).then(function(a){return a?b.upsert(a):BPromise.resolve(!1)})},this.logoutUserSessions=function(a,b,c){var d,e=[];if('all'===b||'other'===b?d=util.getSessions(a):'expired'===b&&(d=util.getExpiredSessions(a,Date.now())),'other'===b&&c){var f=d.indexOf(c);-1<f&&d.splice(f,1)}return d.length&&(e.push(l.deleteTokens(d)),e.push(k.removeKeys(d)),e.push(k.deauthorizeUser(a,d)),('expired'===b||'other'===b)&&d.forEach(function(b){delete a.session[b]})),'all'===b&&delete a.session,BPromise.all(e).then(function(){return BPromise.resolve(a)})},this.remove=function(a,c){var d,e=[];return b.get(a).then(function(a){return j.logoutUserSessions(a,'all')}).then(function(a){return(d=a,!0!==c||!d.personalDBs)?BPromise.resolve():(Object.keys(d.personalDBs).forEach(function(a){'private'===d.personalDBs[a].type&&e.push(k.removeDB(a))}),BPromise.all(e))}).then(function(){return b.remove(d)})},this.removeExpiredKeys=k.removeExpiredKeys.bind(k),this.confirmSession=function(a,b){return l.confirmToken(a,b)},this.quitRedis=function(){return l.quit()},this};