'use strict';var util=require('./util'),extend=require('util')._extend,BPromise=require('bluebird'),RedisAdapter=require('./sessionAdapters/RedisAdapter'),MemoryAdapter=require('./sessionAdapters/MemoryAdapter'),FileAdapter=require('./sessionAdapters/FileAdapter'),tokenPrefix='token';function Session(a){var b,c=a.getItem('session.adapter');b='redis'===c?new RedisAdapter(a):'file'===c?new FileAdapter(a):new MemoryAdapter,this._adapter=b}module.exports=Session,Session.prototype.storeToken=function(a){var b=this;return a=extend({},a),!a.password&&a.salt&&a.derived_key?this._adapter.storeKey(tokenPrefix+':'+a.key,a.expires-Date.now(),JSON.stringify(a)).then(function(){return delete a.salt,delete a.derived_key,BPromise.resolve(a)}):util.hashPassword(a.password).then(function(c){return a.salt=c.salt,a.derived_key=c.derived_key,delete a.password,b._adapter.storeKey(tokenPrefix+':'+a.key,a.expires-Date.now(),JSON.stringify(a))}).then(function(){return delete a.salt,delete a.derived_key,BPromise.resolve(a)})},Session.prototype.deleteTokens=function(a){var b=[];return a instanceof Array||(a=[a]),a.forEach(function(a){b.push(tokenPrefix+':'+a)}),this._adapter.deleteKeys(b)},Session.prototype.confirmToken=function(a,b){var c;return this._adapter.getKey(tokenPrefix+':'+a).then(function(a){return a?(c=JSON.parse(a),util.verifyPassword(c,b)):BPromise.reject('invalid token')}).then(function(){return delete c.salt,delete c.derived_key,BPromise.resolve(c)},function(){return BPromise.reject('invalid token')})},Session.prototype.fetchToken=function(a){return this._adapter.getKey(tokenPrefix+':'+a).then(function(a){return BPromise.resolve(JSON.parse(a))})},Session.prototype.quit=function(){return this._adapter.quit()};